<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Makefiles | Fabian’s online notebook</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Makefiles" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Basics of writing makefiles" />
<meta property="og:description" content="Basics of writing makefiles" />
<link rel="canonical" href="https://fabiangunzinger.github.io/blog/tools/2021/04/29/makefiles.html" />
<meta property="og:url" content="https://fabiangunzinger.github.io/blog/tools/2021/04/29/makefiles.html" />
<meta property="og:site_name" content="Fabian’s online notebook" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-29T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Basics of writing makefiles","url":"https://fabiangunzinger.github.io/blog/tools/2021/04/29/makefiles.html","@type":"BlogPosting","headline":"Makefiles","dateModified":"2021-04-29T00:00:00-05:00","datePublished":"2021-04-29T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://fabiangunzinger.github.io/blog/tools/2021/04/29/makefiles.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://fabiangunzinger.github.io/blog/feed.xml" title="Fabian's online notebook" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Fabian&#39;s online notebook</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Makefiles</h1><p class="page-description">Basics of writing makefiles</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-04-29T00:00:00-05:00" itemprop="datePublished">
        Apr 29, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#tools">tools</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#best-practices">Best practices</a></li>
</ul><ul>
  <li>
    <p>A makefile is a data base that tells the <code class="language-plaintext highlighter-rouge">make</code> utilit how to recompile a
system. In the default use case, <code class="language-plaintext highlighter-rouge">$: make &lt;filename&gt;</code> checks whether <code class="language-plaintext highlighter-rouge">filename</code> is out of date and, if so, recompiles it. In the way I use makefiles, <code class="language-plaintext highlighter-rouge">$: make &lt;rule&gt;</code>
executes a predefined rule to accomplish a certain task like cleaning a
particular dataset.</p>
  </li>
  <li>
    <p>Rules consist of a target (the name of a file to be modified), prerequisites
(other files on which the target depends on), and commands to be run in order
to update the traget based on changes in the prerequisites.</p>
  </li>
  <li>
    <p>A rule tells <code class="language-plaintext highlighter-rouge">make</code> when a target is out of date and how to update it. A
target is out of date if it doesn’t exist or is older then one of its
prerequisite files.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">$: make</code> executes the first specified rule, <code class="language-plaintext highlighter-rouge">$: make &lt;rule&gt;</code> executes a
particular rule.</p>
  </li>
  <li>
    <p>A normal prerequisite makes both an <em>order statement</em> and a <em>dependency statement</em>:
the order statement ensures that all commands needed to produce the
prerequisete are fully executed before any commands to produce the target,
while the dependency statement ensures that the target is updated every time a
prerequisite changes. Occasionally, we want a prerequisite to invoke the order without the
dependency statement (i.e. target is not udpated when the prerequisite
changes, but when target is being updated, then the prerequisite commandas are
run first). We can do this by writing the rule as <code class="language-plaintext highlighter-rouge">target:
normal-prerequisites | order-only-prerequisites</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">make</code> does its work in two phases: during the <em>read-in</em> phase, it reads the
makefile and internalises variables and rules to construct a dependency graph
of all targets and their prerequisies; during the <em>target-update</em> phase, it
determines what rules to update in what order and executes the commandas to do
so.</p>
  </li>
  <li>
    <p>As a result, variable and function expansion can happen either <em>immediately</em>
(during the read-in phase) or <em>deferred</em> (after the read-in phase), and gives
rise to two flavours of variables: <em>recursively expanded variables</em>, defined by
<code class="language-plaintext highlighter-rouge">varname = value</code> are expanded at the time the variable is substituted during
the target-update phase. Before that point, <code class="language-plaintext highlighter-rouge">varname</code> contains the content of
<code class="language-plaintext highlighter-rouge">value</code> verbatim (e.g. if <code class="language-plaintext highlighter-rouge">value</code> is <code class="language-plaintext highlighter-rouge">$(othervar)</code>, then that last string is
the value of <code class="language-plaintext highlighter-rouge">varname</code>). In contrast, <em>simply expanded variables</em>, defined by
<code class="language-plaintext highlighter-rouge">varname := value</code> is expanded immediately when the variable is defined during
the read-in phase (and <code class="language-plaintext highlighter-rouge">varname</code> would be bound to the value of <code class="language-plaintext highlighter-rouge">othervar</code> in
the above example).</p>
  </li>
  <li>
    <p>To define a variable containing all csv files in a directory, do <code class="language-plaintext highlighter-rouge">csvs :=
$(wildcard *.csv)</code>. The <code class="language-plaintext highlighter-rouge">wildcard</code> function is needed here so that the
wildcard gets expanded during function creation (as opposed to creating the
variable with value <code class="language-plaintext highlighter-rouge">*.csv</code>). I could also create a list
containing the same files but with a parquet extensions like so: `parqs :=
$(patsubst %.csv,%.parquet,$(wildcard *.csv)).</p>
  </li>
  <li>
    <p>Automatic variables: <code class="language-plaintext highlighter-rouge">$^</code> is a list of all prerequisites, <code class="language-plaintext highlighter-rouge">$@</code> is the target,
<code class="language-plaintext highlighter-rouge">$&lt;</code> the first prerequisite.</p>
  </li>
  <li>
    <p>If a target is an action to be performed rather than a file to be updated,
then it’s called a <code class="language-plaintext highlighter-rouge">phony target</code>. In this case, telling <code class="language-plaintext highlighter-rouge">make</code> that we’re
using a phone target explicitly by prepending the rule with a line like
<code class="language-plaintext highlighter-rouge">.PHONY : nameofrule</code> is useful for two reasons: <code class="language-plaintext highlighter-rouge">make</code> doesn’t think of a
file called <code class="language-plaintext highlighter-rouge">nameofrule</code> as the target (which, if it did, would mean that our
rule never gets run because it has no prerequisites so that <code class="language-plaintext highlighter-rouge">make</code> would think
of <code class="language-plaintext highlighter-rouge">nameofrule</code> as always up to date) and it doesn’t check for implicit
commands to update the target, which improves performance.</p>
  </li>
  <li>
    <p>Commands begin with a tab and, unless specified otherwise, are executed by
<code class="language-plaintext highlighter-rouge">bin/sh</code>. You can set a different shell by changing the value of the <code class="language-plaintext highlighter-rouge">SHELL</code>
variable (I usually use <code class="language-plaintext highlighter-rouge">SHELL := /bin/bash</code>. Each line that begines with a tab and appears within a rule context
(anything between the start of one rule and another) is interpreted as a
command and sent to the shell.</p>
  </li>
  <li>
    <p>The only thing <code class="language-plaintext highlighter-rouge">make</code> does with commands is to check for <code class="language-plaintext highlighter-rouge">\</code> before newline,
and for variables to expand (if you want <code class="language-plaintext highlighter-rouge">$</code> to appear in the command, use
<code class="language-plaintext highlighter-rouge">$$</code>). To prevent <code class="language-plaintext highlighter-rouge">make</code> from echoing a command, prepend it with <code class="language-plaintext highlighter-rouge">@</code>.</p>
  </li>
  <li>
    <p>Prepend a command with <code class="language-plaintext highlighter-rouge">-</code> if you want <code class="language-plaintext highlighter-rouge">make</code> to continue regardless of
errors. This can be useful for commands like <code class="language-plaintext highlighter-rouge">-rm tempfile.csv</code>, where you
probaby want to continue even if the file didn’t exist and could thus not be
removed.</p>
  </li>
</ul>

<h2 id="best-practices">
<a class="anchor" href="#best-practices" aria-hidden="true"><span class="octicon octicon-link"></span></a>Best practices</h2>

<p>Define a phony target:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.PHONY: clean
clean:
    rm *.csv
</code></pre></div></div>

<p>Make <code class="language-plaintext highlighter-rouge">$: make</code> run all rules:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.PHONY: all
all : rule1 rule2

.PHONY: rule1
rule1:
    mkdir hello

.PHONY: rule2
rule2:
    rm -rf hello
</code></pre></div></div>


  </div><a class="u-url" href="/blog/tools/2021/04/29/makefiles.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Online notebook for code and thoughts.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
