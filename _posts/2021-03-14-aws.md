---
keywords: fastai
title: AWS
hide: false
toc: true
comments: true
categories: [python, pandas, aws]
nb_path: _notebooks/2021-03-14-aws.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-03-14-aws.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Frequently used interaction patterns with AWS.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h1><ul>
<li><p>There are multiple ways to access your AWS account. I store config and credential files in <code>~/.aws</code> as discussed <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html">here</a>. AWS access methods find these files automatically so I don't have to worry about that.</p>
</li>
<li><p>What I do have to worry about is choosing the appropriate profile depending on what AWS account I want to interact with (e.g. my personal one or one for work). This is different for each library, so I cover this below.</p>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="s3fs"><code>s3fs</code><a class="anchor-link" href="#s3fs"> </a></h1><p>Built by people at Dask, <code>s3fs</code> is built on top of <code>botocore</code> and provides a convenient way to interact with S3. It can read and -- I think -- write data, but there are easier ways to do that, and I use the library mainly to navigate buckets and list content.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Navigate-buckets">Navigate buckets<a class="anchor-link" href="#Navigate-buckets"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">s3fs</span>

<span class="c1"># establish connection</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">()</span>

<span class="c1"># count items in s3 root bucket</span>
<span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;/fgu-samples&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;fgu-samples/transactions.parquet&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To choose a profile other than <code>default</code>, use:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="s1">&#39;tracker-fgu&#39;</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>6</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="&#160;Read-and-write-directly-from-Pandas">&#160;Read and write directly from <code>Pandas</code><a class="anchor-link" href="#&#160;Read-and-write-directly-from-Pandas"> </a></h1><ul>
<li><p>Pandas can read and write files to and from S3 directly if you provide the file name as <code>s3://&lt;bucket&gt;/&lt;filename&gt;</code>.</p>
</li>
<li><p>By default, <code>Pandas</code> uses the default profile to access S3. Recent versions of <code>Pandas</code> have a <code>storage_options</code> parameter that can be used to provide, among other things, a profile name.</p>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Basics">Basics<a class="anchor-link" href="#Basics"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># read using default profile </span>

<span class="n">fp</span> <span class="o">=</span> <span class="s1">&#39;s3://fgu-samples/transactions.parquet&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(1168943, 21)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fp</span> <span class="o">=</span> <span class="s1">&#39;s3://temp-mdb/data_XX7.parquet&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">storage_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="s1">&#39;tracker-fgu&#39;</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(9388334, 23)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This works well for simple jobs, but in a large project, passing the profile information to each read and write call is cumbersome and ugly.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simple-improvement-using-functools.partial">Simple improvement using <code>functools.partial</code><a class="anchor-link" href="#Simple-improvement-using-functools.partial"> </a></h2><p><code>functools.partial</code>provides a simple solution, as it allows me to create a custom function with a frozen storage options argument.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>

<span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="s1">&#39;tracker-fgu&#39;</span><span class="p">))</span>
<span class="n">read_parquet_s3</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">read_parquet_s3</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(9388334, 23)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="More-flexible-solution-with-custom-function">More flexible solution with custom function<a class="anchor-link" href="#More-flexible-solution-with-custom-function"> </a></h2><p>Often, I run projects on my Mac for testing and a virtual machine to run the full code. In this case, I need a way to automatically provide the correct profile name.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">s3</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="s1">&#39;tracker-fgu&#39;</span><span class="p">)</span>
<span class="n">s3</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;/raw-mdb/&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;raw-mdb/data_777.csv&#39;, &#39;raw-mdb/data_X77.csv&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">platform</span>

<span class="k">def</span> <span class="nf">get_aws_profile</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return access point specific AWS profile to use for S3 access.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FabsMacBook.local&#39;</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="s1">&#39;tracker-fgu&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>

    <span class="k">return</span> <span class="n">profile</span>


<span class="k">class</span> <span class="nc">s3</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create read and write functions with frozen AWS profile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">get_aws_profile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
    
    

<span class="k">def</span> <span class="nf">make_s3_funcs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return readers and writers with frozen AWS profile name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># identify required profile (depends on project)</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FabsMacBook.local&#39;</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="s1">&#39;tracker-fgu&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
        
    <span class="c1"># create partial readers and writers</span>
    <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">))</span>
    <span class="n">read_csv_s3</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="n">write_csv_s3</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">write_csv</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="n">read_parquet_s3</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="n">write_parquet_s3</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    
<span class="n">fp</span> <span class="o">=</span> <span class="s1">&#39;s3://raw-mdb/data_777.csv&#39;</span>
    
<span class="n">s3</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AttributeError</span>                            Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-16-09c6801ecbd9&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     47</span> fp <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&#39;s3://raw-mdb/data_777.csv&#39;</span>
<span class="ansi-green-intense-fg ansi-bold">     48</span> 
<span class="ansi-green-fg">---&gt; 49</span><span class="ansi-red-fg"> </span>s3<span class="ansi-blue-fg">.</span>read_csv<span class="ansi-blue-fg">(</span>fp<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-16-09c6801ecbd9&gt;</span> in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">     23</span> 
<span class="ansi-green-intense-fg ansi-bold">     24</span>     <span class="ansi-green-fg">def</span> read_csv<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 25</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> functools<span class="ansi-blue-fg">.</span>partial<span class="ansi-blue-fg">(</span>pd<span class="ansi-blue-fg">.</span>read_csv<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>self<span class="ansi-blue-fg">.</span>options<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     26</span> 
<span class="ansi-green-intense-fg ansi-bold">     27</span> 

<span class="ansi-red-fg">AttributeError</span>: &#39;str&#39; object has no attribute &#39;options&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The above is not ideal, as it requires cumbersome unpacking of return. Maybe using decorator is better.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="awswrangler"><code>awswrangler</code><a class="anchor-link" href="#awswrangler"> </a></h1><p>A new <a href="https://github.com/awslabs/aws-data-wrangler">library</a> from AWS labs for Pandas interaction with a number of AWS services. Looks very promising, but haven't had any use for it thus far.</p>

</div>
</div>
</div>
</div>
 

